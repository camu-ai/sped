---
title: Regras dos Web Services
description: Regras cr√≠ticas e limita√ß√µes dos web services da Sefaz que voc√™ DEVE conhecer
---

import { Callout } from 'fumadocs-ui/components/callout';

# ‚ö†Ô∏è Regras Cr√≠ticas dos Web Services

<Callout type="warn">
**ATEN√á√ÉO: Leia Antes de Usar em Produ√ß√£o**

Os web services da Sefaz possuem regras r√≠gidas de uso para prevenir abuso e garantir disponibilidade. **O n√£o cumprimento dessas regras resulta em bloqueio autom√°tico do CNPJ por 1 hora**.
</Callout>

## Regras Gerais de Distribui√ß√£o DFe

### Disponibilidade de Documentos
- **90 dias**: Documentos ficam dispon√≠veis por at√© 3 meses ap√≥s recep√ß√£o
- **50 documentos/consulta**: M√°ximo retornado por requisi√ß√£o
- **Ordem sequencial**: NSUs devem ser consultados em ordem crescente
- **M√∫ltiplas aplica√ß√µes**: Se v√°rias aplica√ß√µes do mesmo CNPJ fazem consultas, todas devem seguir a mesma sequ√™ncia

## üö® `consultaUltNSU` - Regra Cr√≠tica

### Aguardar 1 Hora ap√≥s cStat 137

Quando voc√™ recebe `cStat=137` ("Nenhum documento localizado"), voc√™ **DEVE** aguardar 1 hora antes de fazer uma nova consulta.

```typescript
// ‚ùå ERRADO - Pode causar bloqueio
const resultado1 = await distribuicao.consultaUltNSU({ ultNSU: "000000000000001" })
if (resultado1.data?.cStat === "137") {
  // N√ÉO fa√ßa nova consulta imediatamente!
  const resultado2 = await distribuicao.consultaUltNSU({ ultNSU: "000000000000001" })
}

// ‚úÖ CORRETO - Aguardar 1 hora
const resultado1 = await distribuicao.consultaUltNSU({ ultNSU: "000000000000001" })
if (resultado1.data?.cStat === "137") {
  console.log("Nenhum documento encontrado. Aguardar 1 hora antes da pr√≥xima consulta.")
  // Implementar delay de 1 hora ou agendar para depois
}
```

### Comportamento Esperado
- **cStat 137**: "Nenhum documento localizado" ‚Üí **AGUARDAR 1 HORA**
- **cStat 138**: "Documento(s) localizado(s)" ‚Üí Pode continuar consultando
- **cStat 656**: "Consumo Indevido" ‚Üí **CNPJ BLOQUEADO POR 1 HORA**

## üö® `consultaChNFe` e `consultaNSU` - Limite de Consultas

### Limite: 20 Consultas por Hora

Ambos os m√©todos t√™m limite de **20 consultas por hora por CNPJ**. Exceder esse limite resulta em bloqueio.

```typescript
// ‚ùå ERRADO - Pode exceder limite
for (let i = 0; i < 25; i++) {
  await distribuicao.consultaChNFe({ chNFe: chaves[i] })
}

// ‚úÖ CORRETO - Respeitar limite
const MAX_CONSULTAS_HORA = 20
let consultasRealizadas = 0
const inicioHora = Date.now()

for (const chave of chaves) {
  if (consultasRealizadas >= MAX_CONSULTAS_HORA) {
    const tempoEspera = 3600000 - (Date.now() - inicioHora)
    if (tempoEspera > 0) {
      console.log(`Aguardando ${tempoEspera}ms para nova consulta...`)
      await new Promise(resolve => setTimeout(resolve, tempoEspera))
      consultasRealizadas = 0
    }
  }
  
  await distribuicao.consultaChNFe({ chNFe: chave })
  consultasRealizadas++
}
```

## Manifesta√ß√£o de Eventos - Regras

### Limita√ß√µes por Lote
- **M√°ximo 20 eventos por lote**
- **idLote √∫nico**: N√£o reutilizar identificadores
- **Uma manifesta√ß√£o por tipo**: Cada NFe pode receber apenas um evento de cada tipo

### Evento 210240 - Justificativa Obrigat√≥ria

```typescript
// ‚úÖ CORRETO - Opera√ß√£o n√£o realizada com justificativa
await recepcaoEvento.enviarEvento({
  idLote: Date.now().toString(),
  lote: [{
    chNFe: "35220314200166000187550010000000001123456789",
    tpEvento: TipoEvento.OPERACAO_NAO_REALIZADA,
    justificativa: "Mercadoria n√£o foi entregue devido ao endere√ßo incorreto"
  }]
})
```

## C√≥digos de Status e A√ß√µes

### Distribui√ß√£o DFe

| C√≥digo | Descri√ß√£o | A√ß√£o Necess√°ria |
|--------|-----------|-----------------|
| `137` | Nenhum documento localizado | **Aguardar 1 hora** antes da pr√≥xima consulta |
| `138` | Documento(s) localizado(s) | Processar documentos e continuar |
| `217` | NFe inexistente para a chave informada | Verificar chave de acesso |
| `236` | Chave de Acesso com d√≠gito verificador inv√°lido | Corrigir chave de acesso |
| `589` | NSU superior ao m√°ximo dispon√≠vel | Usar NSU v√°lido |
| `632` | Solicita√ß√£o fora de prazo (>90 dias) | Documento n√£o mais dispon√≠vel |
| `640` | CNPJ/CPF sem permiss√£o para consultar | Verificar permiss√µes |
| `641` | NFe indispon√≠vel para o emitente | Emitente n√£o pode baixar pr√≥pria NFe |
| `653` | NFe Cancelada, indispon√≠vel | Documento cancelado |
| `654` | NFe Denegada, indispon√≠vel | Documento denegado |
| `656` | **Consumo Indevido** | **CNPJ bloqueado por 1 hora** |

### Eventos de Manifesta√ß√£o

| C√≥digo | Descri√ß√£o | A√ß√£o Necess√°ria |
|--------|-----------|-----------------|
| `128` | Lote de evento processado | Verificar status individual dos eventos |
| `135` | Evento registrado e vinculado a NFe | Sucesso |
| `573` | Duplicidade de evento | Evento j√° foi registrado |
| `656` | Rejei√ß√£o: Falha na comunica√ß√£o | Verificar conectividade ou aguardar |

## Implementa√ß√£o de Controle de Rate Limiting

### Classe para Controle de Limites

```typescript
class NFeRateLimiter {
  private consultasChNFe = 0
  private ultimaConsultaChNFe = 0
  private ultimoUltNSUCom137 = 0

  async consultaChNFeComLimite(distribuicao: NFeDistribuicao, chNFe: string) {
    const agora = Date.now()
    
    // Verificar limite de 20/hora
    if (agora - this.ultimaConsultaChNFe > 3600000) {
      this.consultasChNFe = 0
    }
    
    if (this.consultasChNFe >= 20) {
      const espera = 3600000 - (agora - this.ultimaConsultaChNFe)
      throw new Error(`Limite excedido. Aguardar ${espera}ms`)
    }
    
    const resultado = await distribuicao.consultaChNFe({ chNFe })
    this.consultasChNFe++
    this.ultimaConsultaChNFe = agora
    
    return resultado
  }

  async consultaUltNSUComControle(distribuicao: NFeDistribuicao, ultNSU: string) {
    const agora = Date.now()
    
    // Verificar se deve aguardar ap√≥s √∫ltimo 137
    if (this.ultimoUltNSUCom137 && (agora - this.ultimoUltNSUCom137) < 3600000) {
      const espera = 3600000 - (agora - this.ultimoUltNSUCom137)
      throw new Error(`Aguardar ${espera}ms ap√≥s √∫ltimo cStat 137`)
    }
    
    const resultado = await distribuicao.consultaUltNSU({ ultNSU })
    
    if (resultado.data?.cStat === "137") {
      this.ultimoUltNSUCom137 = agora
    }
    
    return resultado
  }
}
```

### Tratamento de Erros Espec√≠ficos

```typescript
async function consultarComTratamento(distribuicao: NFeDistribuicao, ultNSU: string) {
  try {
    const resultado = await distribuicao.consultaUltNSU({ ultNSU })
    
    switch (resultado.data?.cStat) {
      case "137":
        console.log("Nenhum documento encontrado. Aguardando 1 hora...")
        // Implementar l√≥gica de espera
        break
        
      case "138":
        console.log(`Encontrados documentos. Pr√≥ximo NSU: ${resultado.data.ultNSU}`)
        // Processar documentos
        break
        
      case "656":
        console.error("CNPJ bloqueado por uso indevido. Aguardar 1 hora.")
        // Implementar l√≥gica de bloqueio
        break
        
      default:
        console.log(`Status: ${resultado.data?.cStat} - ${resultado.data?.xMotivo}`)
    }
    
    return resultado
  } catch (error) {
    console.error("Erro na consulta:", error)
    throw error
  }
}
```

## ‚ö†Ô∏è Avisos Cr√≠ticos

<Callout type="error">
**NUNCA IGNORE ESTAS REGRAS**:

1. **Nunca ignore cStat 137**: Sempre aguarde 1 hora antes de nova consulta
2. **Monitore limites**: Implemente contadores para evitar exceder 20 consultas/hora
3. **Use NSU sequencial**: Sempre use o √∫ltimo NSU retornado pela consulta anterior
4. **Trate bloqueios**: Implemente l√≥gica para lidar com cStat 656
5. **Teste em homologa√ß√£o**: Valide sua implementa√ß√£o antes de usar em produ√ß√£o
6. **Documente chamadas**: Mantenha log das consultas para debug
7. **Implemente retry**: Use backoff exponencial para falhas tempor√°rias
</Callout>

## Consequ√™ncias do N√£o Cumprimento

**O n√£o cumprimento dessas regras pode resultar em**:
- Bloqueio do seu CNPJ por 1 hora
- Interrup√ß√£o dos servi√ßos fiscais da sua aplica√ß√£o
- Impossibilidade de consultar ou manifestar-se sobre NFe
- Impacto nos processos de neg√≥cio da empresa

## Implementa√ß√£o Recomendada

1. **Sempre implemente controle de rate limiting**
2. **Use filas para processar consultas de forma controlada**
3. **Implemente logs detalhados para auditoria**
4. **Teste extensivamente em homologa√ß√£o**
5. **Monitore os c√≥digos de status em produ√ß√£o**
6. **Tenha planos de conting√™ncia para bloqueios**

**Lembre-se**: A Sefaz implementou essas regras para garantir que o servi√ßo permane√ßa dispon√≠vel para todos. Respeitar essas limita√ß√µes √© essencial para o funcionamento adequado do sistema fiscal brasileiro.