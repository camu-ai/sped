# @camu-ai/sped-nfe

Uma biblioteca TypeScript para consumir os web services da Sefaz brasileira para distribui√ß√£o de NFe (Nota Fiscal Eletr√¥nica) e eventos de manifesta√ß√£o do destinat√°rio. Esta biblioteca fornece uma interface limpa para interagir com os servi√ßos de Distribui√ß√£o DFe e Recep√ß√£o de Eventos da NFe.

## Funcionalidades

- üîê **Autentica√ß√£o por certificado digital** (arquivos PFX ou cert/key)
- üì¶ **Consultas de distribui√ß√£o de documentos NFe** (por ultNSU, NSU ou chNFe)
- üì§ **Eventos de manifesta√ß√£o do destinat√°rio** (confirma√ß√£o, ci√™ncia, etc.)
- üèóÔ∏è **Arquitetura hexagonal** com separa√ß√£o clara de responsabilidades
- ‚úÖ **Suporte completo ao TypeScript** com type safety total
- üß™ **95%+ de cobertura de testes** garantindo confiabilidade
- üåê **Suporte dual de build** (ESM/CJS) para m√°xima compatibilidade
- üéØ **Enums para UF, Ambiente e Tipos de Evento** facilitando o desenvolvimento
- üîÑ **Compatibilidade retroativa** mantida com vers√µes anteriores

## Instala√ß√£o

```bash
npm install @camu-ai/sped-nfe
# ou
yarn add @camu-ai/sped-nfe
# ou
pnpm add @camu-ai/sped-nfe
```

## In√≠cio R√°pido

```typescript
import { createNFeDistribuicao, UFCode, Ambiente } from "@camu-ai/sped-nfe"
import { readFileSync } from "fs"

// Carregue seu certificado
const pfx = readFileSync("./certificado.pfx")

const config = {
  cUFAutor: UFCode.PR, // Paran√°
  cnpj: "12345678901234",
  tpAmb: Ambiente.HOMOLOGACAO, // Homologa√ß√£o
  pfx,
  passphrase: "senha-do-certificado",
}

// Criar inst√¢ncia do controlador de distribui√ß√£o
const distribuicao = createNFeDistribuicao(config)

// Consultar novos documentos
const resultado = await distribuicao.consultaUltNSU({
  ultNSU: "000000000000001",
})

console.log(resultado.data)
```

## Configura√ß√£o

### Autentica√ß√£o por Certificado Digital

A biblioteca suporta dois tipos de autentica√ß√£o por certificado:

#### Op√ß√£o 1: Certificado PFX

```typescript
import { UFCode, Ambiente } from "@camu-ai/sped-nfe"

const config = {
  cUFAutor: UFCode.PR,
  cnpj: "12345678901234",
  tpAmb: Ambiente.HOMOLOGACAO,
  pfx: Buffer.from(conteudoArquivoPfx),
  passphrase: "senha-do-seu-certificado",
}
```

#### Op√ß√£o 2: Arquivos Separados de Certificado e Chave

```typescript
import { UFCode, Ambiente } from "@camu-ai/sped-nfe"

const config = {
  cUFAutor: UFCode.PR,
  cnpj: "12345678901234",
  tpAmb: Ambiente.HOMOLOGACAO,
  cert: "conteudo-do-certificado-string",
  key: "conteudo-da-chave-privada-string",
}
```

### Par√¢metros de Configura√ß√£o

| Par√¢metro    | Tipo                   | Obrigat√≥rio | Descri√ß√£o                                       |
| ------------ | ---------------------- | ----------- | ----------------------------------------------- |
| `cUFAutor`   | UFCode \| string       | Sim         | C√≥digo do estado onde a empresa est√° autorizada |
| `cnpj`       | string                 | Sim\*       | CNPJ da empresa (14 d√≠gitos)                    |
| `cpf`        | string                 | Sim\*       | CPF da pessoa f√≠sica (11 d√≠gitos)               |
| `tpAmb`      | Ambiente \| '1' \| '2' | Sim         | Ambiente: Producao/1 ou Homologacao/2           |
| `pfx`        | Buffer                 | Sim\*\*     | Conte√∫do do arquivo de certificado PFX          |
| `passphrase` | string                 | Sim\*\*     | Senha do certificado PFX                        |
| `cert`       | string                 | Sim\*\*     | Conte√∫do do certificado (alternativa ao PFX)    |
| `key`        | string                 | Sim\*\*     | Conte√∫do da chave privada (alternativa ao PFX)  |

\*Deve ser fornecido `cnpj` ou `cpf`, mas n√£o ambos.
\*\*Deve ser fornecido `pfx` + `passphrase` ou `cert` + `key`.

## Refer√™ncia da API

### Classes Controladoras

#### `NFeDistribuicao`

Classe para controle de distribui√ß√£o de documentos NFe.

```typescript
import { createNFeDistribuicao } from "@camu-ai/sped-nfe"

const distribuicao = createNFeDistribuicao(config)
```

#### `consultaUltNSU(inputs)`

Consulta documentos baseado no √∫ltimo NSU (N√∫mero Sequencial √önico).

```typescript
const resultado = await distribuicao.consultaUltNSU({
  ultNSU: "000000000000001",
})
```

**Par√¢metros:**

- `ultNSU`: √öltimo NSU conhecido (15 d√≠gitos)

**Exemplo de Retorno:**

```typescript
{
  data: {
    tpAmb: "2",
    verAplic: "1.5.11",
    cStat: "138",
    xMotivo: "Documento(s) localizado(s)",
    dhResp: "2022-06-21T10:48:14-03:00",
    ultNSU: "000000000000050",
    maxNSU: "000000000000212",
    docZip: [{
      nsu: "000000000000049",
      schema: "resNFe_v1.01.xsd",
      xml: "<resNFe>...</resNFe>",
      json: { /* XML parseado como JSON */ }
    }]
  },
  reqXml: "<!-- XML da requisi√ß√£o SOAP -->",
  resXml: "<!-- XML da resposta SOAP -->",
  status: 200
}
```

#### `consultaNSU(inputs)`

Consulta um documento espec√≠fico por NSU.

```typescript
const resultado = await distribuicao.consultaNSU({
  NSU: "000000000000045",
})
```

**Par√¢metros:**

- `NSU`: NSU espec√≠fico para consulta (15 d√≠gitos)

#### `consultaChNFe(inputs)`

Consulta um documento espec√≠fico pela chave de acesso da NFe.

```typescript
const resultado = await distribuicao.consultaChNFe({
  chNFe: "41000000000000000000000000000000000000000039",
})
```

**Par√¢metros:**

- `chNFe`: Chave de acesso da NFe (44 d√≠gitos)

### `NFeRecepcaoEvento`

Classe para controle de recep√ß√£o de eventos NFe.

```typescript
import { createNFeRecepcaoEvento } from "@camu-ai/sped-nfe"

const recepcaoEvento = createNFeRecepcaoEvento(config)
```

#### `enviarEvento(inputs)`

Envia eventos de manifesta√ß√£o do destinat√°rio para documentos NFe.

```typescript
import { TipoEvento } from "@camu-ai/sped-nfe"

const resultado = await recepcaoEvento.enviarEvento({
  idLote: "1",
  lote: [
    {
      chNFe: "41000000000000000000000000000000000000000039",
      tpEvento: TipoEvento.CONFIRMACAO_OPERACAO,
    },
  ],
})
```

**Par√¢metros:**

- `idLote`: Identificador do lote (string)
- `lote`: Array de eventos para enviar

**Tipos de Evento:**

- `TipoEvento.CONFIRMACAO_OPERACAO` (210200): Confirma√ß√£o da Opera√ß√£o
- `TipoEvento.CIENCIA_OPERACAO` (210210): Ci√™ncia da Opera√ß√£o
- `TipoEvento.DESCONHECIMENTO_OPERACAO` (210220): Desconhecimento da Opera√ß√£o
- `TipoEvento.OPERACAO_NAO_REALIZADA` (210240): Opera√ß√£o n√£o Realizada

**Exemplo de Retorno:**

```typescript
{
  data: {
    idLote: "1",
    tpAmb: "2",
    verAplic: "AN_1.4.3",
    cOrgao: "91",
    cStat: "128",
    xMotivo: "Lote de evento processado",
    infEvento: [{
      tpAmb: "2",
      verAplic: "AN_1.4.3",
      cOrgao: "91",
      cStat: "135",
      xMotivo: "Evento registrado e vinculado a NF-e",
      chNFe: "41000000000000000000000000000000000000000039",
      tpEvento: "210200",
      xEvento: "Confirmacao da Operacao",
      nSeqEvento: "1",
      CNPJDest: "12345678901234",
      dhRegEvento: "2022-06-21T11:20:10-03:00",
      nProt: "891220000003301"
    }]
  },
  reqXml: "<!-- XML da requisi√ß√£o SOAP -->",
  resXml: "<!-- XML da resposta SOAP -->",
  status: 200
}
```

## Uso Avan√ßado

### Tratamento de Erros

Todas as fun√ß√µes retornam um objeto de resposta que pode conter `data` ou `error`:

```typescript
const resultado = await nfeConsultaUltNSU({ config, ultNSU: "000000000000001" })

if (resultado.error) {
  console.error("Requisi√ß√£o falhou:", resultado.error)
  console.log("XML da Requisi√ß√£o:", resultado.reqXml)
  console.log("XML da Resposta:", resultado.resXml)
  console.log("Status HTTP:", resultado.status)
} else {
  console.log("Sucesso:", resultado.data)
}
```

### Trabalhando com CPF ao inv√©s de CNPJ

```typescript
const configComCpf = {
  cUFAutor: "41",
  cpf: "12345678901", // Use CPF ao inv√©s de CNPJ
  tpAmb: "2",
  pfx: bufferCertificado,
  passphrase: "senha",
}

const resultado = await nfeConsultaUltNSU({
  config: configComCpf,
  ultNSU: "000000000000001",
})
```

### Enviando Eventos com Justificativa

Para eventos que requerem justificativa (como "Opera√ß√£o n√£o Realizada"):

```typescript
const resultado = await nfeEnviarEvento({
  config: configEvento,
  idLote: "1",
  lote: [
    {
      chNFe: "41000000000000000000000000000000000000000039",
      tpEvento: TipoEvento.OPERACAO_NAO_REALIZADA,
      justificativa: "Produto n√£o foi entregue no prazo acordado",
    },
  ],
})
```

### Processando Lotes de Documentos

```typescript
// Obter m√∫ltiplos documentos
const resultado = await nfeConsultaUltNSU({
  config,
  ultNSU: "000000000000001",
})

if (resultado.data?.docZip) {
  for (const doc of resultado.data.docZip) {
    console.log(`Processando documento NSU: ${doc.nsu}`)
    console.log(`Schema: ${doc.schema}`)
    console.log(`Conte√∫do XML:`, doc.xml)
    console.log(`JSON parseado:`, doc.json)
  }
}
```

## Configura√ß√£o de Ambiente

### Ambiente de Produ√ß√£o

```typescript
const configProd = {
  cUFAutor: "41",
  cnpj: "12345678901234",
  tpAmb: "1", // Produ√ß√£o
  pfx: certificadoProducao,
  passphrase: "senha-prod",
}
```

### Ambiente de Homologa√ß√£o

```typescript
const configHom = {
  cUFAutor: "41",
  cnpj: "12345678901234",
  tpAmb: "2", // Homologa√ß√£o
  pfx: certificadoHomologacao,
  passphrase: "senha-hom",
}
```

## C√≥digos de Estados (cUFAutor)

Voc√™ pode usar o enum `UFCode` ou os c√≥digos diretos:

```typescript
import { UFCode } from "@camu-ai/sped-nfe"

// Usando enum (recomendado)
const config = {
  cUFAutor: UFCode.SP, // S√£o Paulo
  // ... outras configura√ß√µes
}

// Ou usando c√≥digo direto
const config2 = {
  cUFAutor: "35", // S√£o Paulo
  // ... outras configura√ß√µes
}
```

**Estados dispon√≠veis:**

- `UFCode.RO` ('11'): Rond√¥nia
- `UFCode.AC` ('12'): Acre
- `UFCode.AM` ('13'): Amazonas
- `UFCode.RR` ('14'): Roraima
- `UFCode.PA` ('15'): Par√°
- `UFCode.AP` ('16'): Amap√°
- `UFCode.TO` ('17'): Tocantins
- `UFCode.MA` ('21'): Maranh√£o
- `UFCode.PI` ('22'): Piau√≠
- `UFCode.CE` ('23'): Cear√°
- `UFCode.RN` ('24'): Rio Grande do Norte
- `UFCode.PB` ('25'): Para√≠ba
- `UFCode.PE` ('26'): Pernambuco
- `UFCode.AL` ('27'): Alagoas
- `UFCode.SE` ('28'): Sergipe
- `UFCode.BA` ('29'): Bahia
- `UFCode.MG` ('31'): Minas Gerais
- `UFCode.ES` ('32'): Esp√≠rito Santo
- `UFCode.RJ` ('33'): Rio de Janeiro
- `UFCode.SP` ('35'): S√£o Paulo
- `UFCode.PR` ('41'): Paran√°
- `UFCode.SC` ('42'): Santa Catarina
- `UFCode.RS` ('43'): Rio Grande do Sul
- `UFCode.MS` ('50'): Mato Grosso do Sul
- `UFCode.MT` ('51'): Mato Grosso
- `UFCode.GO` ('52'): Goi√°s
- `UFCode.DF` ('53'): Distrito Federal

## Suporte ao TypeScript

Esta biblioteca √© escrita em TypeScript e fornece type safety completo:

```typescript
import {
  UFCode,
  Ambiente,
  TipoEvento,
  type NFeDistribuicaoConfig,
  type NFeRecepcaoEventoConfig,
  type DistribuicaoResponse,
  type EventoResponse,
  type EventoLote,
} from "@camu-ai/sped-nfe"

// Todos os par√¢metros e tipos de retorno s√£o tipados
const config: NFeDistribuicaoConfig = {
  cUFAutor: UFCode.PR,
  cnpj: "12345678901234",
  tpAmb: Ambiente.HOMOLOGACAO,
  pfx: bufferCertificado,
  passphrase: "senha",
}

// Exemplo de evento tipado
const evento: EventoLote = {
  chNFe: "41000000000000000000000000000000000000000039",
  tpEvento: TipoEvento.CIENCIA_OPERACAO,
}
```

## Requisitos

- Node.js 16+
- TypeScript 4.7+ (para projetos TypeScript)
- Certificado digital v√°lido emitido por uma Autoridade Certificadora brasileira
- CNPJ ou CPF registrado na Sefaz

## Exemplos Pr√°ticos

### Consulta Completa de Distribui√ß√£o

```typescript
import { nfeConsultaUltNSU } from "@camu-ai/sped-nfe"
import { readFileSync } from "fs"

async function consultarDocumentos() {
  const certificado = readFileSync("./certificado.pfx")

  const config = {
    cUFAutor: "35", // S√£o Paulo
    cnpj: "12345678000195",
    tpAmb: "2", // Homologa√ß√£o
    pfx: certificado,
    passphrase: "minha-senha",
  }

  try {
    const resultado = await nfeConsultaUltNSU({
      config,
      ultNSU: "000000000000001",
    })

    if (resultado.data) {
      console.log("Status:", resultado.data.cStat)
      console.log("Motivo:", resultado.data.xMotivo)
      console.log("√öltimo NSU:", resultado.data.ultNSU)
      console.log("M√°ximo NSU:", resultado.data.maxNSU)

      if (resultado.data.docZip) {
        console.log(`Encontrados ${resultado.data.docZip.length} documentos`)

        resultado.data.docZip.forEach((doc, index) => {
          console.log(`Documento ${index + 1}:`)
          console.log(`  NSU: ${doc.nsu}`)
          console.log(`  Schema: ${doc.schema}`)
          console.log(`  XML: ${doc.xml.substring(0, 100)}...`)
        })
      }
    }
  } catch (error) {
    console.error("Erro na consulta:", error)
  }
}

consultarDocumentos()
```

### Manifesta√ß√£o do Destinat√°rio

```typescript
import { nfeEnviarEvento } from "@camu-ai/sped-nfe"

async function manifestarCiencia() {
  const config = {
    cUFAutor: "35",
    cnpj: "12345678000195",
    tpAmb: "2",
    pfx: certificado,
    passphrase: "senha",
  }

  const resultado = await nfeEnviarEvento({
    config,
    idLote: Date.now().toString(), // ID √∫nico do lote
    lote: [
      {
        chNFe: "35220314200166000187550010000000001123456789",
        tpEvento: TipoEvento.CIENCIA_OPERACAO,
      },
    ],
  })

  if (resultado.data) {
    console.log("Evento processado com sucesso!")
    console.log("ID do Lote:", resultado.data.idLote)
    console.log("Status:", resultado.data.cStat)

    resultado.data.infEvento?.forEach((evento) => {
      console.log(`Evento para NFe ${evento.chNFe}:`)
      console.log(`  Status: ${evento.cStat}`)
      console.log(`  Motivo: ${evento.xMotivo}`)
      console.log(`  Protocolo: ${evento.nProt}`)
    })
  }
}
```

### Opera√ß√£o n√£o Realizada com Justificativa

```typescript
async function rejeitarOperacao() {
  const resultado = await nfeEnviarEvento({
    config,
    idLote: Date.now().toString(),
    lote: [
      {
        chNFe: "35220314200166000187550010000000001123456789",
        tpEvento: TipoEvento.OPERACAO_NAO_REALIZADA,
        justificativa:
          "Mercadoria n√£o foi entregue devido ao endere√ßo incorreto",
      },
    ],
  })

  if (resultado.error) {
    console.error("Erro ao enviar evento:", resultado.error)
  } else {
    console.log("Opera√ß√£o rejeitada com sucesso!")
  }
}
```

## Regras Cr√≠ticas e Limita√ß√µes dos Web Services

### ‚ö†Ô∏è **ATEN√á√ÉO: Leia Antes de Usar em Produ√ß√£o**

Os web services da Sefaz possuem regras r√≠gidas de uso para prevenir abuso e garantir disponibilidade. **O n√£o cumprimento dessas regras resulta em bloqueio autom√°tico do CNPJ por 1 hora**.

### Distribui√ß√£o DFe - Regras Gerais

#### Disponibilidade de Documentos

- **90 dias**: Documentos ficam dispon√≠veis por at√© 3 meses ap√≥s recep√ß√£o
- **50 documentos/consulta**: M√°ximo retornado por requisi√ß√£o
- **Ordem sequencial**: NSUs devem ser consultados em ordem crescente
- **M√∫ltiplas aplica√ß√µes**: Se v√°rias aplica√ß√µes do mesmo CNPJ fazem consultas, todas devem seguir a mesma sequ√™ncia

### `consultaUltNSU` - Regras Espec√≠ficas

#### üö® **Regra Cr√≠tica - Aguardar 1 Hora ap√≥s cStat 137**

```typescript
// ‚ùå ERRADO - Pode causar bloqueio
const resultado1 = await distribuicao.consultaUltNSU({
  ultNSU: "000000000000001",
})
if (resultado1.data?.cStat === "137") {
  // N√ÉO fa√ßa nova consulta imediatamente!
  const resultado2 = await distribuicao.consultaUltNSU({
    ultNSU: "000000000000001",
  })
}

// ‚úÖ CORRETO - Aguardar 1 hora
const resultado1 = await distribuicao.consultaUltNSU({
  ultNSU: "000000000000001",
})
if (resultado1.data?.cStat === "137") {
  console.log(
    "Nenhum documento encontrado. Aguardar 1 hora antes da pr√≥xima consulta."
  )
  // Implementar delay de 1 hora ou agendar para depois
}
```

#### Comportamento Esperado

- **cStat 137**: "Nenhum documento localizado" ‚Üí **AGUARDAR 1 HORA**
- **cStat 138**: "Documento(s) localizado(s)" ‚Üí Pode continuar consultando
- **cStat 656**: "Consumo Indevido" ‚Üí **CNPJ BLOQUEADO POR 1 HORA**

### `consultaChNFe` e `consultaNSU` - Limite de Consultas

#### üö® **Limite: 20 Consultas por Hora**

```typescript
// ‚ùå ERRADO - Pode exceder limite
for (let i = 0; i < 25; i++) {
  await distribuicao.consultaChNFe({ chNFe: chaves[i] })
}

// ‚úÖ CORRETO - Respeitar limite
const MAX_CONSULTAS_HORA = 20
let consultasRealizadas = 0
const inicioHora = Date.now()

for (const chave of chaves) {
  if (consultasRealizadas >= MAX_CONSULTAS_HORA) {
    const tempoEspera = 3600000 - (Date.now() - inicioHora)
    if (tempoEspera > 0) {
      console.log(`Aguardando ${tempoEspera}ms para nova consulta...`)
      await new Promise((resolve) => setTimeout(resolve, tempoEspera))
      consultasRealizadas = 0
    }
  }

  await distribuicao.consultaChNFe({ chNFe: chave })
  consultasRealizadas++
}
```

### Manifesta√ß√£o de Eventos - Regras Espec√≠ficas

#### Limita√ß√µes por Lote

- **M√°ximo 20 eventos por lote**
- **idLote √∫nico**: N√£o reutilizar identificadores
- **Uma manifesta√ß√£o por tipo**: Cada NFe pode receber apenas um evento de cada tipo

#### Evento 210240 - Justificativa Obrigat√≥ria

```typescript
// ‚úÖ CORRETO - Opera√ß√£o n√£o realizada com justificativa
await recepcaoEvento.enviarEvento({
  idLote: Date.now().toString(),
  lote: [
    {
      chNFe: "35220314200166000187550010000000001123456789",
      tpEvento: TipoEvento.OPERACAO_NAO_REALIZADA,
      justificativa: "Mercadoria n√£o foi entregue devido ao endere√ßo incorreto",
    },
  ],
})
```

## C√≥digos de Status e Erros

### Distribui√ß√£o DFe

| C√≥digo | Descri√ß√£o                                       | A√ß√£o Necess√°ria                               |
| ------ | ----------------------------------------------- | --------------------------------------------- |
| `137`  | Nenhum documento localizado                     | **Aguardar 1 hora** antes da pr√≥xima consulta |
| `138`  | Documento(s) localizado(s)                      | Processar documentos e continuar              |
| `217`  | NFe inexistente para a chave informada          | Verificar chave de acesso                     |
| `236`  | Chave de Acesso com d√≠gito verificador inv√°lido | Corrigir chave de acesso                      |
| `589`  | NSU superior ao m√°ximo dispon√≠vel               | Usar NSU v√°lido                               |
| `632`  | Solicita√ß√£o fora de prazo (>90 dias)            | Documento n√£o mais dispon√≠vel                 |
| `640`  | CNPJ/CPF sem permiss√£o para consultar           | Verificar permiss√µes                          |
| `641`  | NFe indispon√≠vel para o emitente                | Emitente n√£o pode baixar pr√≥pria NFe          |
| `653`  | NFe Cancelada, indispon√≠vel                     | Documento cancelado                           |
| `654`  | NFe Denegada, indispon√≠vel                      | Documento denegado                            |
| `656`  | **Consumo Indevido**                            | **CNPJ bloqueado por 1 hora**                 |

### Eventos de Manifesta√ß√£o

| C√≥digo | Descri√ß√£o                           | A√ß√£o Necess√°ria                         |
| ------ | ----------------------------------- | --------------------------------------- |
| `128`  | Lote de evento processado           | Verificar status individual dos eventos |
| `135`  | Evento registrado e vinculado a NFe | Sucesso                                 |
| `573`  | Duplicidade de evento               | Evento j√° foi registrado                |
| `656`  | Rejei√ß√£o: Falha na comunica√ß√£o      | Verificar conectividade ou aguardar     |

## Implementa√ß√£o de Boas Pr√°ticas

### Controle de Rate Limiting

```typescript
class NFeRateLimiter {
  private consultasChNFe = 0
  private ultimaConsultaChNFe = 0
  private ultimoUltNSUCom137 = 0

  async consultaChNFeComLimite(distribuicao: NFeDistribuicao, chNFe: string) {
    const agora = Date.now()

    // Verificar limite de 20/hora
    if (agora - this.ultimaConsultaChNFe > 3600000) {
      this.consultasChNFe = 0
    }

    if (this.consultasChNFe >= 20) {
      const espera = 3600000 - (agora - this.ultimaConsultaChNFe)
      throw new Error(`Limite excedido. Aguardar ${espera}ms`)
    }

    const resultado = await distribuicao.consultaChNFe({ chNFe })
    this.consultasChNFe++
    this.ultimaConsultaChNFe = agora

    return resultado
  }

  async consultaUltNSUComControle(
    distribuicao: NFeDistribuicao,
    ultNSU: string
  ) {
    const agora = Date.now()

    // Verificar se deve aguardar ap√≥s √∫ltimo 137
    if (this.ultimoUltNSUCom137 && agora - this.ultimoUltNSUCom137 < 3600000) {
      const espera = 3600000 - (agora - this.ultimoUltNSUCom137)
      throw new Error(`Aguardar ${espera}ms ap√≥s √∫ltimo cStat 137`)
    }

    const resultado = await distribuicao.consultaUltNSU({ ultNSU })

    if (resultado.data?.cStat === "137") {
      this.ultimoUltNSUCom137 = agora
    }

    return resultado
  }
}
```

### Tratamento de Erros Espec√≠ficos

```typescript
async function consultarComTratamento(
  distribuicao: NFeDistribuicao,
  ultNSU: string
) {
  try {
    const resultado = await distribuicao.consultaUltNSU({ ultNSU })

    switch (resultado.data?.cStat) {
      case "137":
        console.log("Nenhum documento encontrado. Aguardando 1 hora...")
        // Implementar l√≥gica de espera
        break

      case "138":
        console.log(
          `Encontrados documentos. Pr√≥ximo NSU: ${resultado.data.ultNSU}`
        )
        // Processar documentos
        break

      case "656":
        console.error("CNPJ bloqueado por uso indevido. Aguardar 1 hora.")
        // Implementar l√≥gica de bloqueio
        break

      default:
        console.log(
          `Status: ${resultado.data?.cStat} - ${resultado.data?.xMotivo}`
        )
    }

    return resultado
  } catch (error) {
    console.error("Erro na consulta:", error)
    throw error
  }
}
```

## ‚ö†Ô∏è Avisos Importantes

1. **Nunca ignore cStat 137**: Sempre aguarde 1 hora antes de nova consulta
2. **Monitore limites**: Implemente contadores para evitar exceder 20 consultas/hora
3. **Use NSU sequencial**: Sempre use o √∫ltimo NSU retornado pela consulta anterior
4. **Trate bloqueios**: Implemente l√≥gica para lidar com cStat 656
5. **Teste em homologa√ß√£o**: Valide sua implementa√ß√£o antes de usar em produ√ß√£o
6. **Documente chamadas**: Mantenha log das consultas para debug
7. **Implemente retry**: Use backoff exponencial para falhas tempor√°rias

**Lembre-se**: O n√£o cumprimento dessas regras pode resultar em bloqueio do seu CNPJ e interrup√ß√£o dos servi√ßos fiscais da sua aplica√ß√£o.

## Licen√ßa

Licen√ßa MIT - veja o arquivo LICENSE para detalhes.

## Suporte

Para problemas e solicita√ß√µes de recursos, visite nosso [reposit√≥rio no GitHub](https://github.com/camu-ai/sped).

## Documenta√ß√£o Relacionada

- [Manual T√©cnico da NFe](https://www.nfe.fazenda.gov.br/portal/principal.aspx)
- [Documenta√ß√£o dos Web Services da Sefaz](https://www.nfe.fazenda.gov.br/portal/webServices.aspx)
- [Requisitos de Certificado Digital](https://www.nfe.fazenda.gov.br/portal/certificados.aspx)
- [Portal Nacional da NFe](https://www.nfe.fazenda.gov.br/)

## Contribuindo

Contribui√ß√µes s√£o bem-vindas! Por favor, leia nossas diretrizes de contribui√ß√£o antes de enviar um pull request.

## Changelog

Veja o arquivo [CHANGELOG.md](./CHANGELOG.md) para detalhes sobre mudan√ßas em cada vers√£o.
